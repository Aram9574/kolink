name: Production Smoke Tests

on:
  # Manual trigger
  workflow_dispatch:

  # Run every 6 hours to catch issues proactively
  schedule:
    - cron: '0 */6 * * *'

  # Run after successful deployments
  deployment_status:

jobs:
  smoke:
    # Only run on successful deployments or manual/scheduled triggers
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'deployment_status' && github.event.deployment_status.state == 'success')

    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium

      - name: Run smoke tests
        run: npx playwright test e2e/smoke/
        env:
          BASE_URL: https://kolink.es

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results-${{ github.run_number }}
          path: |
            playwright-report/
            test-results/
          retention-days: 7

      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ github.run_number }}
          path: playwright-report/
          retention-days: 7

      - name: Create issue on failure
        if: failure() && (github.event_name == 'schedule' || github.event_name == 'deployment_status')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Production Smoke Tests Failed',
              labels: ['bug', 'critical', 'production'],
              body: `## Smoke Tests Failure Report

            **Trigger:** ${context.eventName}
            **Run ID:** ${context.runId}
            **Commit:** ${context.sha}
            **Workflow:** ${context.workflow}
            **Time:** ${new Date().toISOString()}

            ### Details

            Production smoke tests have failed. This indicates a potential issue with the live application.

            ### Actions Required

            1. Review test failures in the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            2. Check [Sentry](https://sentry.io/organizations/kolink/) for related errors
            3. Verify application health at https://kolink.es/api/health
            4. Review recent deployments and rollback if necessary

            ### Test Results

            View the full test report in the workflow artifacts.

            **Priority:** Critical
            **SLA:** Investigate within 1 hour

            ---
            _Auto-generated by GitHub Actions_`
            });

            console.log(\`Created issue #\${issue.data.number}\`);

      - name: Comment on PR (if applicable)
        if: failure() && github.event.deployment && github.event.deployment.ref
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Find PR associated with this deployment
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              head: `${context.repo.owner}:${github.event.deployment.ref}`
            });

            if (prs.data.length > 0) {
              const pr = prs.data[0];
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `## ‚ö†Ô∏è Smoke Tests Failed

                Production smoke tests failed after deployment.

                **Run:** [View Results](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

                Please investigate before merging additional changes.`
              });
            }
